{% extends 'base.html' %}
{% load album_filters %}

{% block title %}
    {% if current_folder %}{{ current_folder.name }}{% else %}æˆ‘çš„äº‘ç›˜{% endif %}
{% endblock %}

{% block content %}
    <h2 style="margin-bottom: 2rem;">
        {% if query %}
            å¯¹ â€œ<span style="color: #007bff;">{{ query }}</span>â€ çš„æœç´¢ç»“æœï¼š
        {% else %}
            è¯·è¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢ã€‚
        {% endif %}
    </h2>

    {% if query and not folders and not files %}
        <p>æœªæ‰¾åˆ°ä¸ â€œ{{ query }}â€ ç›¸å…³çš„ä»»ä½•æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ã€‚</p>
    {% endif %}

    {% if folders %}
        <h4>æ–‡ä»¶å¤¹</h4>
        <hr>
    {% endif %}
    
    <div class="file-grid">
        {% for folder in folders %}
            <div class="item-container" data-id="folder-{{ folder.id }}" data-type="folder">
                <input type="checkbox" class="item-checkbox">
                <div class="file-item">
                    <a href="{% url 'album:file_list_folder' folder.id %}" class="item-link" title="æ‰“å¼€æ–‡ä»¶å¤¹ {{ folder.name }}">
                        <div class="preview"><span style="font-size: 4rem;">ğŸ“</span></div>
                    </a>
                    <div class="info" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem;">
                        <span class="editable-name" title="åŒå‡»é‡å‘½å">{{ folder.name|truncatechars:20|highlight:query }}</span>
                        <a href="{% url 'album:download_folder_as_zip' folder.id %}" title="æ‰“åŒ…ä¸‹è½½æ­¤æ–‡ä»¶å¤¹" style="color: #007bff; font-size: 1.2rem; text-decoration: none;" onclick="event.stopPropagation();">
                            &#x21E9;
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {% if files %}
    <h4 style="margin-top: 2rem;">æ–‡ä»¶</h4>
    <hr>
    <div class="file-grid">
        {% for file in files %}
            <div class="item-container" data-id="file-{{ file.id }}" data-type="file">
                <input type="checkbox" class="item-checkbox">
                <div class="file-item">
                    <div class="preview">
                        {% if file.file_type == 'image' or file.file_type == 'gif' %}
                            <a href="{{ file.file.url }}" target="_blank" title="ç‚¹å‡»é¢„è§ˆå¤§å›¾"><img src="{{ file.file.url }}" alt="{{ file.file.name }}"></a>
                        {% elif file.file_type == 'video' %}
                            <video controls style="max-width: 100%; max-height: 100%;"><source src="{{ file.file.url }}"></video>
                        {% else %}
                            <a href="{{ file.file.url }}" download="{{ file.file.name }}" title="ä¸‹è½½æ–‡ä»¶"><span style="font-size: 4rem;">ğŸ“„</span></a>
                        {% endif %}
                    </div>
                    <div class="info" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem;">
                        <span class="editable-name" title="åŒå‡»é‡å‘½å">{{ file.file.name|truncatechars:20|highlight:query }}</span>
                        <a href="{{ file.file.url }}" download="{{ file.file.name }}" title="{{ file.file.name }}" class="item-link">
                        </a>
                        
                        <a href="{{ file.file.url }}" download="{{ file.file.name }}" title="ä¸‹è½½æ­¤æ–‡ä»¶" style="color: #007bff; font-size: 1.2rem; text-decoration: none;">
                            &#x21E9; 
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

    <div id="move-modal" class="modal">
        <div class="modal-content">
            <h4>é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹</h4>
            <div id="folder-list" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; margin-top: 1rem;"></div>
            <div class="modal-footer">
                <button id="cancel-move-btn" class="action-btn">å–æ¶ˆ</button>
                <button id="confirm-move-btn" class="action-btn move">ç¡®è®¤ç§»åŠ¨</button>
            </div>
        </div>
    </div>

    <div id="lightbox" class="lightbox">
        <span class="lightbox-close">&times;</span>
        <a class="lightbox-prev">&#10094;</a>
        <a class="lightbox-next">&#10095;</a>
        
        <div class="lightbox-image-wrapper">
            <div id="lightbox-media-container">
                </div>
        </div>

        <div class="lightbox-controls">
            <button id="zoom-in-btn" title="æ”¾å¤§">+</button>
            <button id="zoom-out-btn" title="ç¼©å°">-</button>
            <button id="zoom-reset-btn" title="åŸå§‹å°ºå¯¸">1:1</button>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {{ folder_tree|json_script:"folder-tree-data" }}
    {{ files_for_json|json_script:"files-data" }}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("ã€è¯Šæ–­ã€‘è„šæœ¬å¼€å§‹æ‰§è¡Œï¼Œé¡µé¢DOMå·²åŠ è½½ã€‚");
        // =================================================================
        // ã€å¯å¤ç”¨çš„ã€å¸¦è¿›åº¦æ¡çš„ä¸Šä¼ å‡½æ•°ã€‘
        // =================================================================
        function uploadWithProgress(url, formData, onFinish) {
            const uploadProgressContainer = document.getElementById('upload-progress-container'); // base.html ä¸­çš„ ID
            const uploadProgressBarFill = document.getElementById('upload-progress-fill'); // base.html ä¸­çš„ ID
            const uploadPercentage = document.getElementById('upload-percentage'); // base.html ä¸­çš„ ID
            const uploadFileName = document.getElementById('upload-file-name'); // base.html ä¸­çš„ ID

            if (!uploadProgressContainer || !uploadProgressBarFill || !uploadPercentage || !uploadFileName) {
                console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¿›åº¦æ¡ç›¸å…³çš„HTMLå…ƒç´ ï¼è¯·æ£€æŸ¥base.htmlä¸­çš„IDæ˜¯å¦æ­£ç¡®ã€‚");
                onFinish(false, { error: 'é¡µé¢UIé”™è¯¯ï¼Œæ— æ³•æ‰¾åˆ°è¿›åº¦æ¡å…ƒç´ ã€‚'});
                return;
            }

            // 1. åˆ›å»º XHR å¯¹è±¡
            const xhr = new XMLHttpRequest();
            
            // 2. ç›‘å¬ onprogress äº‹ä»¶
            xhr.upload.addEventListener('progress', function(event) {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    uploadProgressBarFill.style.width = percentComplete + '%';
                    uploadPercentage.textContent = percentComplete + '%';
                }
            });
            
            // 3. ç›‘å¬ä¸Šä¼ å®Œæˆäº‹ä»¶
            xhr.addEventListener('load', function() {
                uploadProgressContainer.style.display = 'none'; // éšè—è¿›åº¦æ¡
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        onFinish(true, response); // è°ƒç”¨æˆåŠŸå›è°ƒ
                    } catch (e) {
                        onFinish(false, { error: 'æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯ã€‚' + e.message });
                    }
                } else {
                    onFinish(false, { error: 'æœåŠ¡å™¨é”™è¯¯: ' + xhr.status + (xhr.responseText ? ' - ' + xhr.responseText : '') });
                }
            });
            
            // 4. ç›‘å¬é”™è¯¯äº‹ä»¶
            xhr.addEventListener('error', function() {
                uploadProgressContainer.style.display = 'none';
                onFinish(false, { error: 'ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚' });
            });
            
            // 5. å‘é€è¯·æ±‚
            uploadProgressContainer.style.display = 'block'; // æ˜¾ç¤ºè¿›åº¦æ¡
            uploadProgressBarFill.style.width = '0%'; // é‡ç½®
            uploadPercentage.textContent = '0%';
            uploadFileName.textContent = 'å‡†å¤‡ä¸Šä¼ ...'; // åˆå§‹åŒ–æ–‡ä»¶åæ˜¾ç¤º

            // å°è¯•ä»formDataä¸­è·å–æ–‡ä»¶åå¹¶æ˜¾ç¤º
            const fileInput = formData.get('files');
            if (fileInput instanceof File) {
                uploadFileName.textContent = fileInput.name;
            } else if (fileInput instanceof FileList && fileInput.length > 0) {
                uploadFileName.textContent = fileInput[0].name + (fileInput.length > 1 ? ` ç­‰ ${fileInput.length} ä¸ªæ–‡ä»¶` : '');
            } else {
                uploadFileName.textContent = 'å¤šä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹';
            }


            xhr.open('POST', url, true);
            const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
            xhr.setRequestHeader('X-CSRFToken', csrfToken);
            xhr.send(formData);
        }

        // =================================================================
        // #1: æ–‡ä»¶å¤¹ä¸Šä¼ é€»è¾‘
        // =================================================================
        const folderUploadInput = document.getElementById('folder_upload_input');
        if (folderUploadInput) {
            folderUploadInput.addEventListener('change', function(event) {
                const files = event.target.files;
                if (files.length === 0) return;

                const formData = new FormData();
                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                formData.append('csrfmiddlewaretoken', csrfToken);
                const relativePaths = [];
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                    relativePaths.push(files[i].webkitRelativePath);
                }
                formData.append('relative_paths', JSON.stringify(relativePaths));

                const uploadUrl = "{% if current_folder %}{% url 'album:upload_folder_subfolder' current_folder.id %}{% else %}{% url 'album:upload_folder_root' %}{% endif %}";
                const uploadLabel = document.getElementById('folder_upload_label');
                const originalText = uploadLabel.textContent;
                uploadLabel.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šä¼ ä¸­...'; // å¸¦æ—‹è½¬å›¾æ ‡

                uploadWithProgress(uploadUrl, formData, (success, response) => {
                    if (success) {
                        window.location.reload();
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                    uploadLabel.innerHTML = originalText; // æ¢å¤æŒ‰é’®æ–‡å­—å’Œå›¾æ ‡
                });
            });
        }
        
        // =================================================================
        // #1.1: å•æ–‡ä»¶ä¸Šä¼ é€»è¾‘ (ä½¿ç”¨æ–°çš„ uploadWithProgress å‡½æ•°)
        // =================================================================
        const fileUploadForm = document.getElementById('file-upload-form');
        const fileUploadInput = document.getElementById('file-upload-input'); // è·å–æ–‡ä»¶è¾“å…¥æ¡†
        if (fileUploadForm && fileUploadInput) {
            // å½“æ–‡ä»¶é€‰æ‹©å˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘ä¸Šä¼ ï¼Œè€Œä¸æ˜¯ç­‰å¾…è¡¨å•æäº¤
            fileUploadInput.addEventListener('change', function() {
                const files = this.files;
                if (files.length === 0) return;

                const url = fileUploadForm.action;
                const formData = new FormData();
                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                formData.append('csrfmiddlewaretoken', csrfToken);
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }

                uploadWithProgress(url, formData, (success, response) => {
                    if (success) { window.location.reload(); }
                    else { alert('ä¸Šä¼ å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯')); }
                });
            });
            // é˜»æ­¢è¡¨å•çš„é»˜è®¤æäº¤è¡Œä¸ºï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡JSå¤„ç†ä¸Šä¼ 
            fileUploadForm.addEventListener('submit', function(event) {
                event.preventDefault();
            });
        }


        // =================================================================
        // #2: é€‰æ‹©æ¨¡å¼ä¸æ‰¹é‡æ“ä½œæ ¸å¿ƒé€»è¾‘ (å¢åŠ è¯Šæ–­ä»£ç )
        // =================================================================
        console.log("ã€è¯Šæ–­ã€‘æ­£åœ¨è·å–æ‰¹é‡æ“ä½œç›¸å…³çš„DOMå…ƒç´ ...");
        const checkboxes = document.querySelectorAll('.item-checkbox');
        // æ³¨æ„ï¼šè¿™é‡Œçš„ actionsBar ç°åœ¨æ˜¯ base.html ä¸­çš„å…¨å±€å…ƒç´ 
        const actionsBar = document.getElementById('actionBar'); // ä½¿ç”¨ base.html ä¸­çš„ ID
        const selectionCountSpan = document.getElementById('selectedCount'); // ä½¿ç”¨ base.html ä¸­çš„ ID
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        
        // --- è·å–æ“ä½œæ å’Œæ¨¡æ€æ¡†ä¸­çš„å…ƒç´  ---
        const downloadButton = document.getElementById('downloadSelectedBtn'); // ä½¿ç”¨ base.html ä¸­çš„ ID
        const moveButton = document.getElementById('moveBtn'); // ä½¿ç”¨ base.html ä¸­çš„ ID
        const deleteButton = document.getElementById('deleteBtn'); // ä½¿ç”¨ base.html ä¸­çš„ ID
        const cancelSelectionBtn = document.getElementById('cancelSelectionBtn'); // ä½¿ç”¨ base.html ä¸­çš„ ID
        
        const moveModal = document.getElementById('moveModal'); // ä½¿ç”¨ base.html ä¸­çš„ ID
        const folderListModal = moveModal ? moveModal.querySelector('#folder-list') : null; // æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºæ–‡ä»¶å¤¹åˆ—è¡¨çš„å®¹å™¨
        const cancelMoveBtn = document.getElementById('cancelMoveBtn'); // ä½¿ç”¨ base.html ä¸­çš„ ID
        const confirmMoveBtn = document.getElementById('confirmMoveBtn'); // ä½¿ç”¨ base.html ä¸­çš„ ID
        
        console.log(`ã€è¯Šæ–­ã€‘è·å–ç»“æœ: æ“ä½œæ (actionsBar) -> ${actionsBar ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
        console.log(`ã€è¯Šæ–­ã€‘è·å–ç»“æœ: æ‰¾åˆ°äº† ${checkboxes.length} ä¸ªé¡¹ç›®å¤é€‰æ¡†ã€‚`);

        let selectedItems = { files: new Set(), folders: new Set() };
        let destinationFolderId = null;

        function updateActionsBar() {
            const totalSelected = selectedItems.files.size + selectedItems.folders.size;
            console.log(`ã€è¯Šæ–­ã€‘updateActionsBar() è¢«è°ƒç”¨ï¼Œæ€»å…±é€‰ä¸­äº† ${totalSelected} é¡¹ã€‚`);
            
            if (!actionsBar || !selectionCountSpan) {
                console.error("ã€è¯Šæ–­ã€‘é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ° actionsBar æˆ– selectionCountSpan å…ƒç´ ï¼");
                return;
            }

            if (totalSelected > 0) {
                selectionCountSpan.textContent = `${totalSelected} ä¸ªé¡¹ç›®å·²é€‰ä¸­`;
                actionsBar.style.display = 'flex';
                console.log("ã€è¯Šæ–­ã€‘æŒ‡ä»¤ï¼šæ˜¾ç¤ºæ“ä½œæ ã€‚");
            } else {
                actionsBar.style.display = 'none';
                console.log("ã€è¯Šæ–­ã€‘æŒ‡ä»¤ï¼šéšè—æ“ä½œæ ã€‚");
                if(selectAllCheckbox) selectAllCheckbox.checked = false;
            }
        }

        // =================================================================
        // #3: ä¸ºå„ä¸ªå…ƒç´ ç»‘å®šäº‹ä»¶ (å¢åŠ è¯Šæ–­ä»£ç )
        // =================================================================

        checkboxes.forEach((checkbox, index) => {
            checkbox.addEventListener('change', function() {
                console.log(`ã€è¯Šæ–­ã€‘ç¬¬ ${index + 1} ä¸ªå¤é€‰æ¡†çš„çŠ¶æ€æ”¹å˜äº†ï¼`);
                
                const container = this.closest('.item-container');
                if (!container) {
                    console.error("ã€è¯Šæ–­ã€‘é”™è¯¯ï¼šæ‰¾ä¸åˆ°çˆ¶å…ƒç´  .item-containerï¼");
                    return;
                }

                const id = container.dataset.id.split('-')[1];
                const type = container.dataset.type;
                console.log(`ã€è¯Šæ–­ã€‘é¡¹ç›®ä¿¡æ¯ -> ç±»å‹: ${type}, ID: ${id}, æ˜¯å¦é€‰ä¸­: ${this.checked}`);

                if (this.checked) {
                    selectedItems[type + 's'].add(id);
                    container.classList.add('selected');
                } else {
                    selectedItems[type + 's'].delete(id);
                    container.classList.remove('selected');
                }
                
                console.log("ã€è¯Šæ–­ã€‘å½“å‰é€‰ä¸­é›†åˆ:", selectedItems);
                
                updateActionsBar();
                // å¦‚æœæ‰€æœ‰å¤é€‰æ¡†éƒ½è¢«é€‰ä¸­ï¼Œæ›´æ–°â€œå…¨é€‰â€å¤é€‰æ¡†çš„çŠ¶æ€
                if (selectAllCheckbox) {
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                }
            });
        });
        
        // --- å…¨é€‰/å…¨ä¸é€‰é€»è¾‘ ---
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                checkboxes.forEach(checkbox => {
                    // åªæœ‰å½“å¤é€‰æ¡†çŠ¶æ€ä¸â€œå…¨é€‰â€ä¸ä¸€è‡´æ—¶æ‰è§¦å‘ change äº‹ä»¶ï¼Œé¿å…æ— é™å¾ªç¯
                    if (checkbox.checked !== isChecked) {
                        checkbox.checked = isChecked;
                        checkbox.dispatchEvent(new Event('change')); // è§¦å‘changeäº‹ä»¶ï¼Œä½¿updateActionsBaræ›´æ–°
                    }
                });
            });
        }

        // --- å–æ¶ˆé€‰æ‹©æŒ‰é’®é€»è¾‘ ---
        if (cancelSelectionBtn) {
            cancelSelectionBtn.addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        checkbox.checked = false;
                        checkbox.dispatchEvent(new Event('change')); // è§¦å‘changeäº‹ä»¶ï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
                    }
                });
                // ç¡®ä¿å…¨é€‰/å…¨ä¸é€‰æ¡†ä¹Ÿå–æ¶ˆé€‰ä¸­
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
                updateActionsBar(); // å¼ºåˆ¶æ›´æ–°æ“ä½œæ çŠ¶æ€
            });
        }
        
        // --- æ‰“åŒ…ä¸‹è½½æŒ‰é’®é€»è¾‘ ---
        if (downloadButton) {
            downloadButton.addEventListener('click', function() {
                const totalSelected = selectedItems.files.size + selectedItems.folders.size;
                if (totalSelected === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„é¡¹ç›®ã€‚');
                    return;
                }

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'album:batch_download' %}";
                form.style.display = 'none';

                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);

                selectedItems.files.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'file_ids';
                    input.value = id;
                    form.appendChild(input);
                });

                selectedItems.folders.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'folder_ids';
                    input.value = id;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            });
        }


        // --- ç§»åŠ¨æŒ‰é’®ï¼šæ‰“å¼€å¹¶å¡«å……ã€å±‚çº§ã€‘æ¨¡æ€æ¡† ---
        if (moveButton && folderListModal) {
             // é€’å½’å‡½æ•°ï¼Œç”¨äºåˆ›å»ºå¸¦ç¼©è¿›çš„æ–‡ä»¶å¤¹åˆ—è¡¨
            function renderFolderTree(nodes, container, indent = 0) {
                nodes.forEach(node => {
                    // é˜»æ­¢å°†é€‰ä¸­çš„æ–‡ä»¶å¤¹ç§»åŠ¨åˆ°è‡ªèº«æˆ–å…¶å­æ–‡ä»¶å¤¹å†…
                    const isSelectedFolder = selectedItems.folders.has(String(node.id));
                    // æ£€æŸ¥å½“å‰æ–‡ä»¶å¤¹æ˜¯å¦æ˜¯ä»»ä½•ä¸€ä¸ªé€‰ä¸­æ–‡ä»¶å¤¹çš„ç¥–å…ˆ (éœ€è¦æ›´å¤æ‚çš„é€»è¾‘ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†)
                    // ç®€å•ç²—æš´çš„æ£€æŸ¥ï¼šå¦‚æœç›®æ ‡æ–‡ä»¶å¤¹æ˜¯å½“å‰é€‰ä¸­çš„æ–‡ä»¶å¤¹ä¹‹ä¸€ï¼Œåˆ™ç¦ç”¨
                    // æ›´ç²¾ç¡®çš„åšæ³•æ˜¯éå†æ‰€æœ‰é€‰ä¸­æ–‡ä»¶å¤¹ï¼Œæ£€æŸ¥ç›®æ ‡æ˜¯å¦åœ¨å…¶è·¯å¾„ä¸‹
                    let isAncestorOfSelected = false;
                    for (let selectedFolderId of selectedItems.folders) {
                        // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–æ£€æŸ¥ï¼Œå¦‚æœéœ€è¦ç²¾ç¡®çš„ç¥–å…ˆæ£€æŸ¥ï¼Œåç«¯è¿”å›çš„ folder_tree éœ€è¦åŒ…å«çˆ¶çº§IDæˆ–å®Œæ•´è·¯å¾„ä¿¡æ¯
                        // ç›®å‰æˆ‘ä»¬åªç®€å•ç¦ç”¨é€‰ä¸­æ–‡ä»¶å¤¹æœ¬èº«
                        if (String(node.id) === selectedFolderId) {
                            isAncestorOfSelected = true;
                            break;
                        }
                    }


                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'folder-item';
                    folderDiv.style.paddingLeft = `${10 + indent * 20}px`; 
                    folderDiv.textContent = 'ğŸ“ ' + node.name;
                    folderDiv.dataset.folderId = node.id;
                    if (isSelectedFolder || isAncestorOfSelected) {
                        folderDiv.classList.add('disabled-dest'); // æ·»åŠ ç¦ç”¨æ ·å¼ç±»
                        folderDiv.style.opacity = '0.5';
                        folderDiv.style.cursor = 'not-allowed';
                    } else {
                        folderDiv.style.cursor = 'pointer';
                    }
                    container.appendChild(folderDiv);
                    if (node.children && node.children.length > 0) {
                        renderFolderTree(node.children, container, indent + 1);
                    }
                });
            }

            moveButton.addEventListener('click', function() {
                const totalSelected = selectedItems.files.size + selectedItems.folders.size;
                if (totalSelected === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„é¡¹ç›®ã€‚');
                    return;
                }
                folderListModal.innerHTML = ''; 
                destinationFolderId = null; 
                
                // æ·»åŠ â€œæ ¹ç›®å½•â€é€‰é¡¹
                const rootOption = document.createElement('div');
                rootOption.className = 'folder-item';
                rootOption.style.paddingLeft = '10px';
                rootOption.textContent = 'æ ¹ç›®å½• (ä¸»é¡µ)';
                rootOption.dataset.folderId = 'null';
                rootOption.style.cursor = 'pointer';
                folderListModal.appendChild(rootOption);

                const folderTreeDataElement = document.getElementById('folder-tree-data');
                const folderTree = JSON.parse(folderTreeDataElement.textContent);
                renderFolderTree(folderTree, folderListModal);

                if (moveModal) moveModal.classList.add('visible');
            });
        }

        // --- åˆ é™¤æŒ‰é’®ï¼šæ‰§è¡Œæ‰¹é‡åˆ é™¤ ---
        if (deleteButton) {
            deleteButton.addEventListener('click', function() {
                const totalSelected = selectedItems.files.size + selectedItems.folders.size;
                if (totalSelected === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®ã€‚');
                    return;
                }
                if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ ${totalSelected} ä¸ªé¡¹ç›®å—ï¼Ÿ\n\nè­¦å‘Šï¼šåˆ é™¤æ–‡ä»¶å¤¹ä¼šä¸€å¹¶åˆ é™¤å…¶å†…éƒ¨æ‰€æœ‰å†…å®¹ï¼`)) {
                    return;
                }
                const dataToSend = {
                    files: Array.from(selectedItems.files),
                    folders: Array.from(selectedItems.folders)
                };
                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                fetch("{% url 'album:batch_delete' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json','X-CSRFToken': csrfToken},
                    body: JSON.stringify(dataToSend)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => { throw new Error(errorData.error || 'æœåŠ¡å™¨é”™è¯¯'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    alert('åˆ é™¤è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯: ' + error.message);
                });
            });
        }

        // --- æ¨¡æ€æ¡†å†…éƒ¨äº‹ä»¶ ---
        if (moveModal && folderListModal && cancelMoveBtn && confirmMoveBtn) {
            cancelMoveBtn.addEventListener('click', function() {
                moveModal.classList.remove('visible');
            });

            folderListModal.addEventListener('click', function(event) {
                const clickedItem = event.target.closest('.folder-item');
                if (clickedItem && !clickedItem.classList.contains('disabled-dest')) { // ç¡®ä¿ä¸æ˜¯è¢«ç¦ç”¨çš„ç›®æ ‡
                    this.querySelectorAll('.folder-item').forEach(item => item.classList.remove('selected-dest'));
                    clickedItem.classList.add('selected-dest');
                    destinationFolderId = clickedItem.dataset.folderId;
                }
            });

            confirmMoveBtn.addEventListener('click', function() {
                if (destinationFolderId === null) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªç›®æ ‡æ–‡ä»¶å¤¹ã€‚');
                    return;
                }
                
                // å†æ¬¡æ£€æŸ¥æ˜¯å¦å°è¯•å°†æ–‡ä»¶å¤¹ç§»åŠ¨åˆ°è‡ªèº«æˆ–å…¶å­æ–‡ä»¶å¤¹
                // è¿™éœ€è¦åç«¯æ”¯æŒï¼Œæˆ–è€…å‰ç«¯æœ‰å®Œæ•´çš„ç›®å½•ç»“æ„æ¥åˆ¤æ–­
                // ç›®å‰ç®€åŒ–å¤„ç†ï¼Œå¦‚æœç›®æ ‡IDæ˜¯é€‰ä¸­çš„æ–‡ä»¶å¤¹ä¹‹ä¸€ï¼Œåˆ™ä¸æ‰§è¡Œ
                if (selectedItems.folders.has(destinationFolderId)) {
                    alert('ä¸èƒ½å°†ä¸€ä¸ªæ–‡ä»¶å¤¹ç§»åŠ¨åˆ°å®ƒè‡ªå·±å†…éƒ¨ï¼');
                    return;
                }

                const dataToSend = {
                    files: Array.from(selectedItems.files),
                    folders: Array.from(selectedItems.folders),
                    destination: destinationFolderId === 'null' ? null : parseInt(destinationFolderId)
                };
                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                fetch("{% url 'album:batch_move' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json','X-CSRFToken': csrfToken},
                    body: JSON.stringify(dataToSend)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => { throw new Error(errorData.error || 'æœåŠ¡å™¨é”™è¯¯'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('ç§»åŠ¨å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡ç§»åŠ¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    alert('ç§»åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯: ' + error.message);
                });
            });
        }
        
        // =================================================================
        // #4: ç¯ç®±(Lightbox)é¢„è§ˆåŠŸèƒ½é€»è¾‘
        // æ³¨æ„ï¼šLightbox ç›¸å…³å…ƒç´ å·²åœ¨ base.html å®šä¹‰ï¼Œç¡®ä¿ ID å’Œç±»åä¸€è‡´ã€‚
        // =================================================================
        const lightbox = document.getElementById('lightbox');
        if (lightbox) {
            const lightboxMediaContainer = document.getElementById('lightbox-media-container');
            const lightboxClose = document.getElementById('lightboxClose'); // ä½¿ç”¨ base.html ä¸­çš„ ID
            const lightboxPrev = document.getElementById('lightboxPrev'); // ä½¿ç”¨ base.html ä¸­çš„ ID
            const lightboxNext = document.getElementById('lightboxNext'); // ä½¿ç”¨ base.html ä¸­çš„ ID
            const zoomInBtn = document.getElementById('zoomInBtn'); // ä½¿ç”¨ base.html ä¸­çš„ ID
            const zoomOutBtn = document.getElementById('zoomOutBtn'); // ä½¿ç”¨ base.html ä¸­çš„ ID
            const rotateLeftBtn = document.getElementById('rotateLeftBtn'); // base.html ä¸­çš„æ–°æŒ‰é’®
            const rotateRightBtn = document.getElementById('rotateRightBtn'); // base.html ä¸­çš„æ–°æŒ‰é’®

            let previewableItems = [];
            let currentIndex = -1;
            let currentScale = 1.0;
            let currentRotation = 0; // æ–°å¢ï¼šæ—‹è½¬è§’åº¦
            let mediaElement = null;

            // ã€ç¬¬1æ­¥ã€‘å°†åç«¯ä¼ å…¥çš„JSONæ•°æ®è§£æå‡ºæ¥ï¼Œå¹¶å­˜å…¥ä¸€ä¸ªMapï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾
            const filesDataElement = document.getElementById('files-data');
            const filesList = JSON.parse(filesDataElement.textContent);
            const filesMap = new Map(filesList.map(file => [String(file.id), file]));

            document.querySelectorAll('.file-item .preview a.item-link').forEach(link => { // ç¡®ä¿åªé€‰æ‹©æ­£ç¡®çš„é“¾æ¥
                const container = link.closest('.item-container');
                const itemType = container.dataset.type;

                if (itemType === 'file') {
                    const fileId = container.dataset.id.split('-')[1];
                    const file = filesMap.get(fileId);
                    if (!file) return;

                    const url = file.url.toLowerCase();
                    let mediaType = 'other';
                    if (url.match(/\.(jpeg|jpg|png|webp|heic|heif)$/)) { // gif å•ç‹¬å¤„ç†
                        mediaType = 'image';
                    } else if (url.match(/\.(gif)$/)) { // GIF è§†ä¸ºå›¾ç‰‡ï¼Œä½†å¯èƒ½ä¸è¿›è¡Œç¼©æ”¾æ—‹è½¬
                        mediaType = 'gif';
                    } else if (url.match(/\.(mp4|webm|ogg|mov)$/)) {
                        mediaType = 'video';
                    }

                    if (mediaType === 'image' || mediaType === 'gif' || mediaType === 'video') {
                        const itemIndex = previewableItems.length;
                        previewableItems.push({ type: mediaType, src: file.url });

                        link.addEventListener('click', function(event) {
                            event.preventDefault();
                            openLightbox(itemIndex);
                        });
                    }
                }
            });
            
            function applyTransform() { 
                if(mediaElement) { 
                    mediaElement.style.transform = `scale(${currentScale}) rotate(${currentRotation}deg)`; 
                    // ç¡®ä¿æ—‹è½¬ä¸­å¿ƒæ˜¯å›¾ç‰‡ä¸­å¿ƒ
                    mediaElement.style.transformOrigin = 'center center';
                } 
            }
            
            function openLightbox(index) {
                if (index < 0 || index >= previewableItems.length) return;
                currentIndex = index;
                const item = previewableItems[currentIndex];
                lightboxMediaContainer.innerHTML = ''; 
                currentScale = 1.0; 
                currentRotation = 0; // é‡ç½®æ—‹è½¬è§’åº¦
                
                // æ ¹æ®åª’ä½“ç±»å‹åˆ›å»ºä¸åŒçš„å…ƒç´ 
                if (item.type === 'image' || item.type === 'gif') { // GIF ä¹Ÿç”¨ img æ ‡ç­¾
                    mediaElement = document.createElement('img');
                    mediaElement.src = item.src;
                } else if (item.type === 'video') {
                    mediaElement = document.createElement('video');
                    mediaElement.src = item.src;
                    mediaElement.controls = true; 
                    mediaElement.autoplay = true; 
                    mediaElement.loop = true; // è§†é¢‘å¾ªç¯æ’­æ”¾
                }

                if (mediaElement) {
                    lightboxMediaContainer.appendChild(mediaElement);
                }

                applyTransform();
                lightbox.style.display = 'flex';
                document.addEventListener('keydown', handleKeyboardNav);
            }
            
            function closeLightbox() {
                lightbox.style.display = 'none';
                if (mediaElement && mediaElement.tagName === 'VIDEO') {
                    mediaElement.pause();
                }
                mediaElement = null; 
                document.removeEventListener('keydown', handleKeyboardNav);
            }

            function changeSlide(n) {
                let newIndex = currentIndex + n;
                if (newIndex >= previewableItems.length) { newIndex = 0; }
                else if (newIndex < 0) { newIndex = previewableItems.length - 1; }
                openLightbox(newIndex);
            }
            
            function handleKeyboardNav(e) {
                if (e.key === 'ArrowRight') { changeSlide(1); }
                else if (e.key === 'ArrowLeft') { changeSlide(-1); }
                else if (e.key === 'Escape') { closeLightbox(); }
            }
            
            lightboxClose.addEventListener('click', closeLightbox);
            lightboxPrev.addEventListener('click', () => changeSlide(-1));
            lightboxNext.addEventListener('click', () => changeSlide(1));
            lightbox.addEventListener('click', function(event) { 
                // ä»…å½“ç‚¹å‡»èƒŒæ™¯æ—¶å…³é—­ï¼Œä¸åŒ…æ‹¬ç‚¹å‡»åª’ä½“å†…å®¹æœ¬èº«æˆ–æ§ä»¶
                if (event.target === lightbox || event.target === lightboxMediaContainer || event.target.closest('.lightbox-image-wrapper') === lightboxMediaContainer) { 
                    closeLightbox(); 
                } 
            });

            if (zoomInBtn) zoomInBtn.addEventListener('click', function() { currentScale = Math.min(3.0, currentScale + 0.2); applyTransform(); }); // é™åˆ¶æœ€å¤§ç¼©æ”¾
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', function() { currentScale = Math.max(0.2, currentScale - 0.2); applyTransform(); }); // é™åˆ¶æœ€å°ç¼©æ”¾
            // æ³¨æ„ï¼šbase.html ä¸­ç°åœ¨æ˜¯ rotateLeftBtn å’Œ rotateRightBtnï¼Œä¸å†æ˜¯ zoom-reset-btn
            // å¦‚æœéœ€è¦é‡ç½®ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªé¢å¤–çš„æŒ‰é’®æˆ–è€…ä¿®æ”¹ç°æœ‰æŒ‰é’®çš„åŠŸèƒ½
            if (rotateLeftBtn) rotateLeftBtn.addEventListener('click', function() { currentRotation = (currentRotation - 90) % 360; applyTransform(); });
            if (rotateRightBtn) rotateRightBtn.addEventListener('click', function() { currentRotation = (currentRotation + 90) % 360; applyTransform(); });
            // å¦‚æœå¸Œæœ›ä¿ç•™é‡ç½®åŠŸèƒ½ï¼Œå¯ä»¥è¿™æ ·æ·»åŠ 
            const zoomResetBtn = document.getElementById('zoomResetBtn'); // å‡è®¾åœ¨base.htmlä¸­æœ‰ä¸€ä¸ªIDä¸ºzoomResetBtnçš„æŒ‰é’®
            if (zoomResetBtn) {
                zoomResetBtn.addEventListener('click', function() {
                    currentScale = 1.0;
                    currentRotation = 0;
                    applyTransform();
                });
            }
        }


        // =================================================================
        // #6: é‡å‘½ååŠŸèƒ½é€»è¾‘
        // =================================================================
        document.querySelectorAll('.editable-name').forEach(nameSpan => {
        nameSpan.addEventListener('dblclick', function(event) {
            event.preventDefault();
            event.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘è¿›å…¥æ–‡ä»¶å¤¹ç­‰é“¾æ¥

            const container = this.closest('.item-container');
            const originalName = this.textContent.trim();
            const itemType = container.dataset.type;
            // å¯¹äºæ–‡ä»¶ï¼Œæˆ‘ä»¬è¦å»æ‰æ‰©å±•åå†ç¼–è¾‘
            let nameWithoutExt = originalName;
            let fileExtension = '';
            if (itemType === 'file') {
                const lastDotIndex = originalName.lastIndexOf('.');
                if (lastDotIndex !== -1) {
                    nameWithoutExt = originalName.substring(0, lastDotIndex);
                    fileExtension = originalName.substring(lastDotIndex);
                }
            }
            
            // åˆ›å»ºä¸€ä¸ªè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.value = nameWithoutExt;
            input.className = 'rename-input'; // å¯ä»¥ä¸ºå®ƒåŠ ç‚¹æ ·å¼
            input.style.cssText = `
                width: calc(100% - 1.2rem); /* é€‚åº”çˆ¶å®¹å™¨å®½åº¦ */
                padding: 4px 6px;
                border: 1px solid #007bff;
                border-radius: 4px;
                font-size: 0.95rem;
                box-sizing: border-box;
                position: absolute; /* è®©è¾“å…¥æ¡†æµ®åŠ¨åœ¨åŸä½ç½® */
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 3; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            `;
            
            // ç”¨è¾“å…¥æ¡†æ›¿æ¢æ‰æ–‡å­—
            this.style.visibility = 'hidden'; // éšè—åŸæ–‡æœ¬è€Œä¸æ˜¯ display: none
            const parentInfo = this.parentElement;
            parentInfo.appendChild(input); // æ·»åŠ åˆ° info åŒºåŸŸ
            input.focus();
            input.select();

            // ç¡®è®¤æˆ–å–æ¶ˆé‡å‘½å
            const confirmOrCancel = (event) => {
                if (event.type === 'keydown' && event.key !== 'Enter' && event.key !== 'Escape') {
                    return; // åªå¤„ç†å›è½¦å’ŒEsc
                }
                
                let newName = input.value.trim();
                
                // å¦‚æœæ˜¯æŒ‰äº† Esc æˆ–è€…åå­—æ²¡å˜ï¼Œåˆ™å–æ¶ˆ
                if (event.key === 'Escape' || newName === nameWithoutExt || newName === "") {
                    cleanup();
                    return;
                }
                
                // æ–‡ä»¶é‡å‘½åæ—¶ï¼Œå°†æ‰©å±•ååŠ å›å»
                if (itemType === 'file' && !newName.endsWith(fileExtension)) {
                    newName += fileExtension;
                }

                // å‘é€è¯·æ±‚åˆ°åç«¯
                const itemId = container.dataset.id.split('-')[1];
                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

                fetch("{% url 'album:rename_item' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        item_type: itemType,
                        new_name: newName
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => { throw new Error(errorData.error || 'æœåŠ¡å™¨é”™è¯¯'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // æˆåŠŸåï¼Œæ›´æ–°é¡µé¢ä¸Šçš„åå­—
                        nameSpan.textContent = data.new_name;
                    } else {
                        alert('é‡å‘½åå¤±è´¥: ' + data.error);
                    }
                    cleanup();
                })
                .catch(error => {
                    console.error("é‡å‘½åæ—¶å‡ºé”™:", error);
                    alert("é‡å‘½åæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯: " + error.message);
                    cleanup();
                });
            };
            
            const cleanup = () => {
                input.removeEventListener('blur', confirmOrCancel);
                input.removeEventListener('keydown', confirmOrCancel);
                if(input.parentElement) {
                    input.parentElement.removeChild(input);
                }
                nameSpan.style.visibility = 'visible'; // æ¢å¤æ˜¾ç¤º
            };

            input.addEventListener('blur', confirmOrCancel); // å¤±å»ç„¦ç‚¹æ—¶
            input.addEventListener('keydown', confirmOrCancel); // æŒ‰é”®æ—¶
        });
    });
    </script>
{% endblock %}