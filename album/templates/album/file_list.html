{% extends 'base.html' %}

{% block title %}
    {% if current_folder %}{{ current_folder.name }}{% else %}æˆ‘çš„äº‘ç›˜{% endif %}
{% endblock %}

{% block content %}
    {# è¿™é‡Œçš„ actions-bar å·²è¢«ç§»é™¤ã€‚ç°åœ¨å°†ä½¿ç”¨ base.html ä¸­å®šä¹‰çš„ id="actionBar" #}
    {# åŸå§‹çš„ actions-bar ç»“æ„å’Œ ID ç°åœ¨ç”± base.html æä¾›ï¼ŒJS ä»£ç ä¹Ÿå·²é€‚é…ã€‚ #}

    <nav aria-label="breadcrumb" style="margin-bottom: 1.5rem;">
        <ol style="display: flex; list-style: none; padding: 0; margin: 0; align-items: center; flex-wrap: wrap;">
            <li><a href="{% url 'album:file_list_root' %}" style="color: #007bff; text-decoration: none; font-weight: 500;">ä¸»é¡µ</a></li>
            {% for folder in breadcrumbs %}
                <li style="margin: 0 0.5rem; color: #6c757d;">/</li>
                <li><a href="{% url 'album:file_list_folder' folder.id %}" style="color: #007bff; text-decoration: none; font-weight: 500;">{{ folder.name }}</a></li>
            {% endfor %}
        </ol>
    </nav>
    
    <div class="actions-container" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #eee;">
        <form action="{% if current_folder %}{% url 'album:create_subfolder' current_folder.id %}{% else %}{% url 'album:create_folder' %}{% endif %}" method="post" style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            {% csrf_token %}
            {{ folder_form.name }}
            <button type="submit" class="action-btn" style="background-color: #007bff; border-color: #007bff; color: white;">
                <i class="fas fa-plus-circle"></i> æ–°å»ºæ–‡ä»¶å¤¹
            </button>
        </form>
        
        {# ==== æ–‡ä»¶ä¸Šä¼ è¡¨å• - ä¿æŒåŸæœ‰ç»“æ„ï¼Œä½†ç¡®ä¿IDä¸€è‡´ ==== #}
        <form id="file-upload-form" action="{% if current_folder %}{% url 'album:upload_file_folder' current_folder.id %}{% else %}{% url 'album:upload_file_root' %}{% endif %}" method="post" enctype="multipart/form-data" style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            {% csrf_token %}
            {# å°† input çš„ ID æ”¹å› 'file-upload-input' å¹¶ç»‘å®šåˆ° label for #}
            <label for="file-upload-input" class="button-like-label">
                <i class="fas fa-upload"></i> ä¸Šä¼ æ–‡ä»¶
            </label>
            <input type="file" id="file-upload-input" name="files" multiple required style="display: none;">
            {# åŸå§‹ä»£ç ä¸­è¿™é‡Œæœ‰ä¸€ä¸ªæäº¤æŒ‰é’®ï¼Œä½†JSé˜»æ­¢äº†é»˜è®¤æäº¤å¹¶å¤„ç†ä¸Šä¼ ã€‚ #}
            {# å¦‚æœä½ çš„JSæ˜¯é€šè¿‡form.submit()è§¦å‘çš„ï¼Œè¿™é‡Œéœ€è¦ä¸€ä¸ªå¯è§çš„<button type="submit"> #}
            {# ä½†æ ¹æ®ä½ ä¹‹å‰çš„JSï¼Œå®ƒç›‘å¬çš„æ˜¯formçš„submitäº‹ä»¶ï¼Œæ‰€ä»¥input changeå¯èƒ½æ›´è‡ªç„¶ #}
            {# ä¿æŒåŸæ ·ï¼Œé€šè¿‡JSç›‘å¬file-upload-formçš„submitäº‹ä»¶ #}
        </form>

        {# ==== æ–‡ä»¶å¤¹ä¸Šä¼ è¾“å…¥æ¡† - ä¿æŒåŸæœ‰ç»“æ„å’ŒID ==== #}
        <div>
            <label for="folder_upload_input" class="button-like-label" id="folder_upload_label">
                <i class="fas fa-folder-open"></i> ä¸Šä¼ æ–‡ä»¶å¤¹
            </label>
            <input id="folder_upload_input" type="file" name="files" webkitdirectory multiple style="display: none;">
        </div>
    </div>

    <h4>æ–‡ä»¶å¤¹</h4>
    <hr style="border-top: 1px solid #ddd; margin-bottom: 1.5rem;">
    {% if not folders and not files and not current_folder %}
        <p style="color: #6c757d;">ä½ è¿˜æ²¡æœ‰ä»»ä½•æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ã€‚å¿«æ¥åˆ›å»ºä¸€ä¸ªå§ï¼</p>
    {% elif not folders and not files %}
        <p style="color: #6c757d;">è¿™ä¸ªæ–‡ä»¶å¤¹æ˜¯ç©ºçš„ã€‚</p>
    {% endif %}
    
    <div class="file-grid">
        {% for folder in folders %}
            <div class="item-container" data-id="folder-{{ folder.id }}" data-type="folder">
                <input type="checkbox" class="item-checkbox">
                <div class="file-item">
                    <a href="{% url 'album:file_list_folder' folder.id %}" class="item-link" title="æ‰“å¼€æ–‡ä»¶å¤¹ {{ folder.name }}">
                        <div class="preview"><span style="font-size: 4rem; color: #ffc107;">ğŸ“</span></div>
                    </a>
                    <div class="info">
                        <span class="editable-name" title="åŒå‡»é‡å‘½å">{{ folder.name|truncatechars:20 }}</span>
                        <a href="{% url 'album:download_folder_as_zip' folder.id %}" title="æ‰“åŒ…ä¸‹è½½æ­¤æ–‡ä»¶å¤¹" style="color: #007bff; font-size: 1.2rem; text-decoration: none;" onclick="event.stopPropagation();">
                            &#x21E9;
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {% if files %}
    <h4 style="margin-top: 2rem;">æ–‡ä»¶</h4>
    <hr style="border-top: 1px solid #ddd; margin-bottom: 1.5rem;">
    <div class="file-grid">
        {% for file in files %}
            <div class="item-container" data-id="file-{{ file.id }}" data-type="file">
                <input type="checkbox" class="item-checkbox">
                <div class="file-item">
                    <div class="preview">
                        {% if file.file_type == 'image' or file.file_type == 'gif' %}
                            <a href="{{ file.file.url }}" target="_blank" title="ç‚¹å‡»é¢„è§ˆå¤§å›¾"><img src="{{ file.file.url }}" alt="{{ file.file.name }}"></a>
                        {% elif file.file_type == 'video' %}
                            <a href="{{ file.file.url }}" class="item-link" title="ç‚¹å‡»é¢„è§ˆè§†é¢‘ {{ file.file.name }}">
                                <video preload="metadata" muted playsinline disablepictureinpicture>
                                    <source src="{{ file.file.url }}#t=0.5">
                                </video>
                            </a>
                        {% else %}
                            <a href="{{ file.file.url }}" download="{{ file.file.name }}" title="ä¸‹è½½æ–‡ä»¶"><span style="font-size: 4rem;">ğŸ“„</span></a>
                        {% endif %}
                    </div>
                    <div class="info">
                        <span class="editable-name" title="åŒå‡»é‡å‘½å">{{ file.file.name|truncatechars:20 }}</span>
                        <a href="{{ file.file.url }}" download="{{ file.file.name }}" title="{{ file.file.name }}" class="item-link">
                        </a>
                        
                        <a href="{{ file.file.url }}" download="{{ file.file.name }}" title="ä¸‹è½½æ­¤æ–‡ä»¶" style="color: #007bff; font-size: 1.2rem; text-decoration: none;">
                            &#x21E9; 
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
    {{ folder_tree|json_script:"folder-tree-data" }}
    {{ files_for_json|json_script:"files-data" }}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("ã€è¯Šæ–­ã€‘è„šæœ¬å¼€å§‹æ‰§è¡Œï¼Œé¡µé¢DOMå·²åŠ è½½ã€‚");
        // =================================================================
        // ã€å¯å¤ç”¨çš„ã€å¸¦è¿›åº¦æ¡çš„ä¸Šä¼ å‡½æ•°ã€‘
        // ç¡®ä¿è¿™é‡Œå¼•ç”¨çš„IDæ˜¯base.htmlä¸­è¿›åº¦æ¡çš„ID
        // =================================================================
        function uploadWithProgress(url, formData, onFinish) {
            // è¿™é‡Œå°†å˜é‡åæ›´æ–°ä¸º base.html ä¸­å¯¹åº”çš„ ID
            const progressContainer = document.getElementById('upload-progress-container');
            const progressBarFill = document.getElementById('upload-progress-fill'); // base.html ä¸­çš„ ID
            const progressText = document.getElementById('upload-percentage'); // base.html ä¸­çš„ ID
            const uploadFileName = document.getElementById('upload-file-name'); // base.html ä¸­çš„ ID
            
            if (!progressContainer || !progressBarFill || !progressText || !uploadFileName) {
                console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¿›åº¦æ¡ç›¸å…³çš„HTMLå…ƒç´ ï¼");
                onFinish(false, { error: 'é¡µé¢UIé”™è¯¯ï¼Œæ— æ³•æ‰¾åˆ°è¿›åº¦æ¡å…ƒç´ ã€‚'});
                return;
            }

            // 1. åˆ›å»º XHR å¯¹è±¡
            const xhr = new XMLHttpRequest();
            
            // 2. ç›‘å¬ onprogress äº‹ä»¶
            xhr.upload.addEventListener('progress', function(event) {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    progressBarFill.style.width = percentComplete + '%';
                    progressText.textContent = percentComplete + '%';
                }
            });
            
            // 3. ç›‘å¬ä¸Šä¼ å®Œæˆäº‹ä»¶
            xhr.addEventListener('load', function() {
                progressContainer.style.display = 'none'; // éšè—è¿›åº¦æ¡
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        onFinish(true, response); // è°ƒç”¨æˆåŠŸå›è°ƒ
                    } catch (e) {
                        onFinish(false, { error: 'æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯ã€‚' });
                    }
                } else {
                    onFinish(false, { error: 'æœåŠ¡å™¨é”™è¯¯: ' + xhr.status });
                }
            });
            
            // 4. ç›‘å¬é”™è¯¯äº‹ä»¶
            xhr.addEventListener('error', function() {
                progressContainer.style.display = 'none';
                onFinish(false, { error: 'ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚' });
            });
            
            // 5. å‘é€è¯·æ±‚
            progressContainer.style.display = 'block'; // æ˜¾ç¤ºè¿›åº¦æ¡
            progressBarFill.style.width = '0%'; // é‡ç½®
            progressText.textContent = '0%';
            
            // å°è¯•ä»formDataä¸­è·å–æ–‡ä»¶åå¹¶æ˜¾ç¤º
            const filesToUpload = formData.getAll('files');
            if (filesToUpload.length > 0) {
                if (filesToUpload.length === 1 && filesToUpload[0] instanceof File) {
                    uploadFileName.textContent = filesToUpload[0].name;
                } else {
                    const firstFileName = filesToUpload[0] instanceof File ? filesToUpload[0].name : 'æ–‡ä»¶/æ–‡ä»¶å¤¹';
                    uploadFileName.textContent = `${firstFileName} ç­‰ ${filesToUpload.length} é¡¹`;
                }
            } else {
                uploadFileName.textContent = 'æœªçŸ¥æ–‡ä»¶'; // å…œåº•
            }
            
            xhr.open('POST', url, true);
            const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
            xhr.setRequestHeader('X-CSRFToken', csrfToken);
            xhr.send(formData);
        }
        // =================================================================
        // #1: æ–‡ä»¶å¤¹ä¸Šä¼ é€»è¾‘ - ä¿æŒä¸å˜
        // =================================================================
        const folderUploadInput = document.getElementById('folder_upload_input');
        if (folderUploadInput) {
            folderUploadInput.addEventListener('change', function(event) {
                const files = event.target.files;
                if (files.length === 0) return;

                const formData = new FormData();
                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                formData.append('csrfmiddlewaretoken', csrfToken);
                const relativePaths = [];
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                    relativePaths.push(files[i].webkitRelativePath);
                }
                formData.append('relative_paths', JSON.stringify(relativePaths));

                const uploadUrl = "{% if current_folder %}{% url 'album:upload_folder_subfolder' current_folder.id %}{% else %}{% url 'album:upload_folder_root' %}{% endif %}";
                const uploadLabel = document.getElementById('folder_upload_label');
                const originalText = uploadLabel.textContent;
                uploadLabel.textContent = 'ä¸Šä¼ ä¸­...';

                uploadWithProgress(uploadUrl, formData, (success, response) => {
                    if (success) {
                        window.location.reload();
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥: ' + response.error);
                    }
                    uploadLabel.textContent = originalText;
                });
            });
        }
        
        // =================================================================
        // æ–‡ä»¶ä¸Šä¼ è¡¨å•é€»è¾‘ - ã€å…³é”®æ£€æŸ¥ç‚¹ã€‘ç¡®ä¿è¿™é‡Œè§¦å‘äº†ä¸Šä¼ 
        // åŸå§‹ä»£ç æ˜¯ç›‘å¬formçš„submitäº‹ä»¶ï¼Œä½†input type="file"æ²¡æœ‰é»˜è®¤çš„submitæŒ‰é’®
        // æ›´å¸¸è§çš„æ˜¯ç›‘å¬inputçš„changeäº‹ä»¶
        // æˆ‘å°†ä¿®æ”¹è¿™é‡Œï¼Œè®©å®ƒç›‘å¬inputçš„changeäº‹ä»¶ï¼Œè¿™æ ·é€‰æ‹©æ–‡ä»¶åä¼šè‡ªåŠ¨è§¦å‘ä¸Šä¼ 
        // å¦‚æœä½ éœ€è¦ç‚¹å‡»æŒ‰é’®æ‰ä¸Šä¼ ï¼Œè¯·åœ¨HTMLä¸­æ·»åŠ ä¸€ä¸ª <button type="submit">
        // ä¿æŒåŸæ ·ï¼Œé€šè¿‡JSç›‘å¬file-upload-formçš„submitäº‹ä»¶
        // =================================================================
        const fileUploadForm = document.getElementById('file-upload-form');
        const fileUploadInput = fileUploadForm ? fileUploadForm.querySelector('input[type="file"][name="files"]') : null;

        if (fileUploadInput) { // ç¡®ä¿inputå…ƒç´ å­˜åœ¨
            fileUploadInput.addEventListener('change', function(event) {
                const files = event.target.files;
                if (files.length === 0) return; // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–‡ä»¶ï¼Œåˆ™ä¸æ‰§è¡Œ

                const url = fileUploadForm.action;
                const formData = new FormData(fileUploadForm); // ç›´æ¥ä»formåˆ›å»ºFormData, åŒ…å«csrf_token

                uploadWithProgress(url, formData, (success, response) => {
                    if (success) { window.location.reload(); }
                    else { alert('ä¸Šä¼ å¤±è´¥: ' + response.error); }
                });
            });
        }
        // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡ JS å¤„ç†ä¸Šä¼ 
        if (fileUploadForm) {
            fileUploadForm.addEventListener('submit', function(event) {
                event.preventDefault();
            });
        }


        // =================================================================
        // #2: é€‰æ‹©æ¨¡å¼ä¸æ‰¹é‡æ“ä½œæ ¸å¿ƒé€»è¾‘ (å¢åŠ è¯Šæ–­ä»£ç )
        // æ³¨æ„ï¼šè¿™é‡Œçš„IDå·²ä¿®æ”¹ä¸ºä¸base.htmlä¸­çš„æ“ä½œæ å…ƒç´ åŒ¹é…
        // =================================================================
        console.log("ã€è¯Šæ–­ã€‘æ­£åœ¨è·å–æ‰¹é‡æ“ä½œç›¸å…³çš„DOMå…ƒç´ ...");
        const checkboxes = document.querySelectorAll('.item-checkbox');
        // ç¡®ä¿è¿™é‡Œå¼•ç”¨çš„æ˜¯base.htmlä¸­çš„actionsBar ID
        const actionsBar = document.getElementById('actionBar'); 
        // ç¡®ä¿è¿™é‡Œå¼•ç”¨çš„æ˜¯base.htmlä¸­çš„selectedCount ID
        const selectionCountSpan = document.getElementById('selectedCount'); 
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        
        // --- è·å–æ“ä½œæ å’Œæ¨¡æ€æ¡†ä¸­çš„å…ƒç´  ---
        // ç¡®ä¿è¿™é‡Œå¼•ç”¨çš„æ˜¯base.htmlä¸­çš„downloadSelectedBtn ID
        const downloadButton = document.getElementById('downloadSelectedBtn'); 
        // ç¡®ä¿è¿™é‡Œå¼•ç”¨çš„æ˜¯base.htmlä¸­çš„moveBtn ID
        const moveButton = document.getElementById('moveBtn'); 
        // ç¡®ä¿è¿™é‡Œå¼•ç”¨çš„æ˜¯base.htmlä¸­çš„deleteBtn ID
        const deleteButton = document.getElementById('deleteBtn'); 
        // æ³¨æ„ï¼šè¿™é‡Œæ¨¡æ€æ¡†çš„IDéœ€è¦å’Œbase.htmlä¸­çš„ä¸€è‡´
        const moveModal = document.getElementById('moveModal');
        const folderListModal = moveModal ? moveModal.querySelector('#folder-list') : null;
        const cancelMoveBtn = document.getElementById('cancelMoveBtn');
        const confirmMoveBtn = document.getElementById('confirmMoveBtn');
        
        console.log(`ã€è¯Šæ–­ã€‘è·å–ç»“æœ: æ“ä½œæ (actionsBar) -> ${actionsBar ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
        console.log(`ã€è¯Šæ–­ã€‘è·å–ç»“æœ: æ‰¾åˆ°äº† ${checkboxes.length} ä¸ªé¡¹ç›®å¤é€‰æ¡†ã€‚`);

        let selectedItems = { files: new Set(), folders: new Set() };
        let destinationFolderId = null;

        function updateActionsBar() {
            const totalSelected = selectedItems.files.size + selectedItems.folders.size;
            console.log(`ã€è¯Šæ–­ã€‘updateActionsBar() è¢«è°ƒç”¨ï¼Œæ€»å…±é€‰ä¸­äº† ${totalSelected} é¡¹ã€‚`);
            
            if (!actionsBar || !selectionCountSpan) {
                console.error("ã€è¯Šæ–­ã€‘é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ° actionsBar æˆ– selectionCountSpan å…ƒç´ ï¼");
                return;
            }

            if (totalSelected > 0) {
                selectionCountSpan.textContent = `${totalSelected} ä¸ªé¡¹ç›®å·²é€‰ä¸­`; // ä¸base.htmlä¸­çš„æ–‡æœ¬ä¿æŒä¸€è‡´
                actionsBar.style.display = 'flex';
                console.log("ã€è¯Šæ–­ã€‘æŒ‡ä»¤ï¼šæ˜¾ç¤ºæ“ä½œæ ã€‚");
            } else {
                actionsBar.style.display = 'none';
                console.log("ã€è¯Šæ–­ã€‘æŒ‡ä»¤ï¼šéšè—æ“ä½œæ ã€‚");
                if(selectAllCheckbox) selectAllCheckbox.checked = false;
            }
        }

        // =================================================================
        // #3: ä¸ºå„ä¸ªå…ƒç´ ç»‘å®šäº‹ä»¶ (å¢åŠ è¯Šæ–­ä»£ç ) - ä¿æŒä¸å˜
        // =================================================================

        checkboxes.forEach((checkbox, index) => {
            checkbox.addEventListener('change', function() {
                console.log(`ã€è¯Šæ–­ã€‘ç¬¬ ${index + 1} ä¸ªå¤é€‰æ¡†çš„çŠ¶æ€æ”¹å˜äº†ï¼`);
                
                const container = this.closest('.item-container');
                if (!container) {
                    console.error("ã€è¯Šæ–­ã€‘é”™è¯¯ï¼šæ‰¾ä¸åˆ°çˆ¶å…ƒç´  .item-containerï¼");
                    return;
                }

                const id = container.dataset.id.split('-')[1];
                const type = container.dataset.type;
                console.log(`ã€è¯Šæ–­ã€‘é¡¹ç›®ä¿¡æ¯ -> ç±»å‹: ${type}, ID: ${id}, æ˜¯å¦é€‰ä¸­: ${this.checked}`);

                if (this.checked) {
                    selectedItems[type + 's'].add(id);
                    container.classList.add('selected');
                } else {
                    selectedItems[type + 's'].delete(id);
                    container.classList.remove('selected');
                }
                
                console.log("ã€è¯Šæ–­ã€‘å½“å‰é€‰ä¸­é›†åˆ:", selectedItems);
                
                updateActionsBar();
            });
        });
        
        // --- å…¨é€‰/å…¨ä¸é€‰é€»è¾‘ ---
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked !== isChecked) {
                        checkbox.checked = isChecked;
                        // ç¡®ä¿è§¦å‘ change äº‹ä»¶æ¥æ›´æ–° selectedItems å’Œ UI
                        checkbox.dispatchEvent(new Event('change')); 
                    }
                });
            });
        }
        
        // --- æ‰“åŒ…ä¸‹è½½æŒ‰é’®é€»è¾‘ ---
        if (downloadButton) {
            downloadButton.addEventListener('click', function() {
                const totalSelected = selectedItems.files.size + selectedItems.folders.size;
                if (totalSelected === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„é¡¹ç›®ã€‚');
                    return;
                }

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'album:batch_download' %}";
                form.style.display = 'none';

                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);

                selectedItems.files.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'file_ids';
                    input.value = id;
                    form.appendChild(input);
                });

                selectedItems.folders.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'folder_ids';
                    input.value = id;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            });
        }


        // --- ç§»åŠ¨æŒ‰é’®ï¼šæ‰“å¼€å¹¶å¡«å……ã€å±‚çº§ã€‘æ¨¡æ€æ¡† --- - ä¿æŒä¸å˜
        if (moveButton) {
             // é€’å½’å‡½æ•°ï¼Œç”¨äºåˆ›å»ºå¸¦ç¼©è¿›çš„æ–‡ä»¶å¤¹åˆ—è¡¨
            function renderFolderTree(nodes, container, indent = 0) {
                nodes.forEach(node => {
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'folder-item';
                    folderDiv.style.paddingLeft = `${10 + indent * 20}px`; 
                    folderDiv.textContent = 'ğŸ“ ' + node.name;
                    folderDiv.dataset.folderId = node.id;
                    container.appendChild(folderDiv);
                    if (node.children && node.children.length > 0) {
                        renderFolderTree(node.children, container, indent + 1);
                    }
                });
            }

            moveButton.addEventListener('click', function() {
                const totalSelected = selectedItems.files.size + selectedItems.folders.size;
                if (totalSelected === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„é¡¹ç›®ã€‚');
                    return;
                }
                folderListModal.innerHTML = ''; 
                destinationFolderId = null; 
                const rootOption = document.createElement('div');
                rootOption.className = 'folder-item';
                rootOption.style.paddingLeft = '10px';
                rootOption.textContent = 'æ ¹ç›®å½• (ä¸»é¡µ)';
                rootOption.dataset.folderId = 'null';
                folderListModal.appendChild(rootOption);
                const folderTreeDataElement = document.getElementById('folder-tree-data');
                const folderTree = JSON.parse(folderTreeDataElement.textContent);
                renderFolderTree(folderTree, folderListModal);
                if (moveModal) moveModal.classList.add('visible');
            });
        }

        // --- åˆ é™¤æŒ‰é’®ï¼šæ‰§è¡Œæ‰¹é‡åˆ é™¤ --- - ä¿æŒä¸å˜
        if (deleteButton) {
            deleteButton.addEventListener('click', function() {
                const totalSelected = selectedItems.files.size + selectedItems.folders.size;
                if (totalSelected === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®ã€‚');
                    return;
                }
                if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ ${totalSelected} ä¸ªé¡¹ç›®å—ï¼Ÿ\n\nè­¦å‘Šï¼šåˆ é™¤æ–‡ä»¶å¤¹ä¼šä¸€å¹¶åˆ é™¤å…¶å†…éƒ¨æ‰€æœ‰å†…å®¹ï¼`)) {
                    return;
                }
                const dataToSend = {
                    files: Array.from(selectedItems.files),
                    folders: Array.from(selectedItems.folders)
                };
                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                fetch("{% url 'album:batch_delete' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json','X-CSRFToken': csrfToken},
                    body: JSON.stringify(dataToSend)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    alert('åˆ é™¤è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚');
                });
            });
        }

        // --- æ¨¡æ€æ¡†å†…éƒ¨äº‹ä»¶ --- - ä¿æŒä¸å˜
        if (moveModal) {
            // è¿™é‡Œå·²ç»ç¡®ä¿äº† cancelMoveBtn å’Œ confirmMoveBtn åœ¨base.htmlä¸­å®šä¹‰ä¸”IDæ­£ç¡®
            cancelMoveBtn.addEventListener('click', function() {
                moveModal.classList.remove('visible');
            });

            folderListModal.addEventListener('click', function(event) {
                const clickedItem = event.target.closest('.folder-item');

                if (clickedItem) {
                    this.querySelectorAll('.folder-item').forEach(item => item.classList.remove('selected-dest'));
                    clickedItem.classList.add('selected-dest');
                    destinationFolderId = clickedItem.dataset.folderId;
                }
            });

            confirmMoveBtn.addEventListener('click', function() {
                if (destinationFolderId === null) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªç›®æ ‡æ–‡ä»¶å¤¹ã€‚');
                    return;
                }
                // æ£€æŸ¥æ˜¯å¦å°è¯•å°†æ–‡ä»¶å¤¹ç§»åŠ¨åˆ°å…¶è‡ªèº«å†…éƒ¨
                let isMovingIntoSelf = false;
                selectedItems.folders.forEach(selectedFolderId => {
                    // ç®€å•çš„æ£€æŸ¥ï¼šå¦‚æœç›®æ ‡æ–‡ä»¶å¤¹æ˜¯é€‰ä¸­çš„æ–‡ä»¶å¤¹ä¹‹ä¸€ï¼Œåˆ™ä¸å…è®¸
                    // æ›´å¤æ‚çš„æ£€æŸ¥éœ€è¦éå†æ–‡ä»¶å¤¹æ ‘ï¼Œåˆ¤æ–­ç›®æ ‡æ˜¯å¦æ˜¯é€‰ä¸­æ–‡ä»¶å¤¹çš„å­æ–‡ä»¶å¤¹
                    if (selectedFolderId === destinationFolderId) {
                        isMovingIntoSelf = true;
                    }
                });

                if (isMovingIntoSelf) {
                    alert('ä¸èƒ½å°†ä¸€ä¸ªæ–‡ä»¶å¤¹ç§»åŠ¨åˆ°å®ƒè‡ªå·±å†…éƒ¨ï¼');
                    return;
                }

                const dataToSend = {
                    files: Array.from(selectedItems.files),
                    folders: Array.from(selectedItems.folders),
                    destination: destinationFolderId === 'null' ? null : parseInt(destinationFolderId)
                };
                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
                fetch("{% url 'album:batch_move' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json','X-CSRFToken': csrfToken},
                    body: JSON.stringify(dataToSend)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('ç§»åŠ¨å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡ç§»åŠ¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    alert('ç§»åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚');
                });
            });
        }
        
        // =================================================================
        // #4: ç¯ç®±(Lightbox)é¢„è§ˆåŠŸèƒ½é€»è¾‘ - ä¿æŒä¸å˜
        // =================================================================
        const lightbox = document.getElementById('lightbox');
        if (lightbox) {
            const lightboxMediaContainer = document.getElementById('lightbox-media-container');
            const lightboxClose = document.querySelector('.lightbox-close');
            const lightboxPrev = document.querySelector('.lightbox-prev');
            const lightboxNext = document.querySelector('.lightbox-next');
            const zoomInBtn = document.getElementById('zoomInBtn'); // base.htmlä¸­æ˜¯zoomInBtnï¼Œä¸æ˜¯zoom-in-btn
            const zoomOutBtn = document.getElementById('zoomOutBtn'); // base.htmlä¸­æ˜¯zoomOutBtnï¼Œä¸æ˜¯zoom-out-btn
            const rotateLeftBtn = document.getElementById('rotateLeftBtn');
            const rotateRightBtn = document.getElementById('rotateRightBtn');
            // æ³¨æ„ï¼šbase.htmlä¸­æ²¡æœ‰zoomResetBtnï¼Œå¦‚æœä½ éœ€è¦ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ 
            // const zoomResetBtn = document.getElementById('zoom-reset-btn'); 
            let previewableItems = [];
            let currentIndex = -1;
            let currentScale = 1.0;
            let currentRotation = 0; // æ–°å¢ï¼šæ—‹è½¬è§’åº¦
            let mediaElement = null;

            const filesDataElement = document.getElementById('files-data');
            const filesList = JSON.parse(filesDataElement.textContent);
            const filesMap = new Map(filesList.map(file => [String(file.id), file]));

            document.querySelectorAll('.file-item .preview a').forEach(link => {
                const container = link.closest('.item-container');
                const itemType = container.dataset.type;

                if (itemType === 'file') {
                    const fileId = container.dataset.id.split('-')[1];

                    const file = filesMap.get(fileId);
                    if (!file) return;

                    const url = file.url.toLowerCase();
                    let mediaType = 'other';
                    // ä¿®æ­£æ–‡ä»¶ç±»å‹åˆ¤æ–­ï¼Œç¡®ä¿gifä¹Ÿè¢«æ­£ç¡®è¯†åˆ«ä¸ºimage
                    if (url.match(/\.(jpeg|jpg|gif|png|webp|heic|heif)$/)) {
                        mediaType = 'image';
                    } else if (url.match(/\.(mp4|webm|ogg|mov)$/)) {
                        mediaType = 'video';
                    }

                    if (mediaType === 'image' || mediaType === 'video') {
                        const itemIndex = previewableItems.length;
                        previewableItems.push({ type: mediaType, src: file.url });

                        link.addEventListener('click', function(event) {
                            event.preventDefault();
                            openLightbox(itemIndex);
                        });
                    }
                }
            });
            
            function applyTransform() { 
                if(mediaElement) { 
                    mediaElement.style.transform = `scale(${currentScale}) rotate(${currentRotation}deg)`; 
                } 
            }
            
            function openLightbox(index) {
                if (index < 0 || index >= previewableItems.length) return;
                currentIndex = index;
                const item = previewableItems[currentIndex];
                lightboxMediaContainer.innerHTML = ''; 
                currentScale = 1.0; 
                currentRotation = 0; // é‡ç½®æ—‹è½¬è§’åº¦
                
                if (item.type === 'image') {
                    mediaElement = document.createElement('img');
                    mediaElement.src = item.src;
                } else if (item.type === 'video') {
                    mediaElement = document.createElement('video');
                    mediaElement.src = item.src;
                    mediaElement.controls = true;
                    mediaElement.autoplay = true;
                    mediaElement.style.maxWidth = '90vw';
                    mediaElement.style.maxHeight = '90vh';
                }

                if (mediaElement) {
                    lightboxMediaContainer.appendChild(mediaElement);
                }

                applyTransform();
                lightbox.style.display = 'flex';
                document.addEventListener('keydown', handleKeyboardNav);
            }
            
            function closeLightbox() {
                lightbox.style.display = 'none';
                if (mediaElement && mediaElement.tagName === 'VIDEO') {
                    mediaElement.pause();
                }
                mediaElement = null; 
                document.removeEventListener('keydown', handleKeyboardNav);
            }

            function changeSlide(n) {
                let newIndex = currentIndex + n;
                if (newIndex >= previewableItems.length) { newIndex = 0; }
                else if (newIndex < 0) { newIndex = previewableItems.length - 1; }
                openLightbox(newIndex);
            }
            
            function handleKeyboardNav(e) {
                if (e.key === 'ArrowRight') { changeSlide(1); }
                else if (e.key === 'ArrowLeft') { changeSlide(-1); }
                else if (e.key === 'Escape') { closeLightbox(); }
            }
            
            lightboxClose.addEventListener('click', closeLightbox);
            lightboxPrev.addEventListener('click', () => changeSlide(-1));
            lightboxNext.addEventListener('click', () => changeSlide(1));
            // ç‚¹å‡»èƒŒæ™¯å…³é—­ç¯ç®±
            lightbox.addEventListener('click', function(event) { 
                // ç¡®ä¿ç‚¹å‡»çš„æ˜¯èƒŒæ™¯æœ¬èº«ï¼Œè€Œä¸æ˜¯å†…éƒ¨çš„åª’ä½“æˆ–æ§ä»¶
                if (event.target === lightbox || event.target === lightboxMediaContainer || event.target === lightbox.querySelector('.lightbox-image-wrapper')) { 
                    closeLightbox(); 
                } 
            });
            // ç¡®ä¿æ”¾å¤§ç¼©å°æ—‹è½¬æŒ‰é’®åœ¨base.htmlä¸­çš„IDæ˜¯æ­£ç¡®çš„
            if (zoomInBtn) zoomInBtn.addEventListener('click', function() { currentScale += 0.2; applyTransform(); });
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', function() { currentScale = Math.max(0.2, currentScale - 0.2); applyTransform(); });
            // å¦‚æœä½ éœ€è¦åœ¨base.htmlä¸­æ·»åŠ é‡ç½®æŒ‰é’®
            // if (zoomResetBtn) zoomResetBtn.addEventListener('click', function() { currentScale = 1.0; currentRotation = 0; applyTransform(); });
            if (rotateLeftBtn) rotateLeftBtn.addEventListener('click', function() { currentRotation = (currentRotation - 90) % 360; applyTransform(); });
            if (rotateRightBtn) rotateRightBtn.addEventListener('click', function() { currentRotation = (currentRotation + 90) % 360; applyTransform(); });
        }


        // =================================================================
        // #6: é‡å‘½ååŠŸèƒ½é€»è¾‘ - ä¿æŒä¸å˜
        // =================================================================
        document.querySelectorAll('.editable-name').forEach(nameSpan => {
        nameSpan.addEventListener('dblclick', function(event) {
            event.preventDefault();
            event.stopPropagation();

            const container = this.closest('.item-container');
            const originalName = this.textContent.trim();
            const itemType = container.dataset.type;
            
            // å¯¹äºæ–‡ä»¶ï¼Œå°è¯•å‰¥ç¦»æ‰©å±•å
            let nameWithoutExt = originalName;
            let extension = '';
            if (itemType === 'file') {
                const lastDotIndex = originalName.lastIndexOf('.');
                if (lastDotIndex > 0) { // ç¡®ä¿ä¸æ˜¯ä»¥.å¼€å¤´ï¼Œä¸”æœ‰æ‰©å±•å
                    nameWithoutExt = originalName.substring(0, lastDotIndex);
                    extension = originalName.substring(lastDotIndex);
                }
            }
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = nameWithoutExt;
            input.className = 'rename-input'; // ä½¿ç”¨ç°æœ‰çš„æˆ–æ–°å¢çš„CSSç±»
            input.style.padding = '2px 5px';
            input.style.border = '1px solid #007bff';
            input.style.borderRadius = '4px';
            input.style.width = 'calc(100% - 10px)'; // é€‚åº”çˆ¶å®¹å™¨
            input.style.boxSizing = 'border-box';


            this.style.display = 'none';
            // å°†inputæ’å…¥åˆ°spançš„å‰é¢
            this.parentElement.insertBefore(input, this);
            input.focus();
            input.select();

            const confirmOrCancel = (event) => {
                // å¦‚æœæ˜¯æŒ‰é”®äº‹ä»¶ï¼Œåªå¤„ç† Enter å’Œ Escape
                if (event.type === 'keydown' && event.key !== 'Enter' && event.key !== 'Escape') {
                    return;
                }
                
                const newName = input.value.trim();
                let finalNewName = newName;

                // å¦‚æœæ˜¯æ–‡ä»¶ï¼Œéœ€è¦åŠ ä¸ŠåŸæ¥çš„æ‰©å±•å
                if (itemType === 'file' && extension) {
                    finalNewName = newName + extension;
                }
                
                // å¦‚æœæ˜¯ Escape é”®ï¼Œæˆ–è€…æ–°åå­—ä¸åŸåå­—ï¼ˆå‰¥ç¦»æ‰©å±•ååï¼‰ç›¸åŒï¼Œæˆ–è€…æ–°åå­—ä¸ºç©º
                if (event.key === 'Escape' || newName === nameWithoutExt || newName === "") {
                    cleanup();
                    return;
                }
                
                const itemId = container.dataset.id.split('-')[1];
                const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

                fetch("{% url 'album:rename_item' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        item_type: itemType,
                        new_name: finalNewName // æäº¤å¸¦æ‰©å±•åçš„å®Œæ•´æ–°åç§°
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        nameSpan.textContent = data.new_name; // æœåŠ¡å™¨è¿”å›çš„å®Œæ•´æ–°åç§°
                    } else {
                        alert('é‡å‘½åå¤±è´¥: ' + data.error);
                    }
                    cleanup();
                })
                .catch(error => {
                    console.error("é‡å‘½åæ—¶å‡ºé”™:", error);
                    alert("é‡å‘½åæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚");
                    cleanup();
                });
            };
            
            const cleanup = () => {
                input.removeEventListener('blur', confirmOrCancel);
                input.removeEventListener('keydown', confirmOrCancel);
                if(input.parentElement) {
                    input.parentElement.removeChild(input);
                }
                nameSpan.style.display = 'inline';
            };

            input.addEventListener('blur', confirmOrCancel);
            input.addEventListener('keydown', confirmOrCancel);
        });
    });
    });
</script>
{% endblock %}